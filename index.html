<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guessmoji - Daily Emoji Challenge</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 30px; background-color: #f9f9f9; }
    h1 { font-size: 2em; }
    .emoji { font-size: 3em; margin: 20px 0; }
    input { padding: 10px; font-size: 1em; width: 250px; max-width: 90%; display: block; margin: 8px auto; }
    button { padding: 10px 15px; font-size: 1em; cursor: pointer; }
    #result { margin-top: 15px; font-size: 1.2em; }
    footer { margin-top: 40px; font-size: 0.8em; color: #777; }

    .rankings { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; margin-top: 30px; }
    .ranking-box { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; width: 300px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .ranking-box h2 { font-size: 1.2em; margin-bottom: 10px; }
    .ranking-box table { width: 100%; border-collapse: collapse; }
    .ranking-box th, .ranking-box td { padding: 5px; border-bottom: 1px solid #eee; text-align: left; font-size: 0.9em; }
    .ranking-box th { background-color: #f5f5f5; }
  </style>
</head>
<body>

<h1>Guessmoji</h1>
<p>Can you guess today‚Äôs emoji puzzle? One challenge per day, worldwide!</p>

<div id="emojis">Loading...</div>

<input id="username" placeholder="Enter your name" />
<input id="guess" placeholder="Type your answer here" />
<button id="submitBtn">Submit</button>

<p id="result"></p>

<div class="rankings">
  <div class="ranking-box">
    <h2>üèÜ Daily Top</h2>
    <table id="dailyRanking">
      <thead>
        <tr><th>#</th><th>User</th><th>Points</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="ranking-box">
    <h2>üåç Overall Top</h2>
    <table id="overallRanking">
      <thead>
        <tr><th>#</th><th>User</th><th>Points</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<footer>
  &copy; 2025 Guessmoji. All rights reserved.
</footer>

<script>
let answer = "";
let altAnswers = [];
let attempts = 0;
let challengeLoadedTime = new Date();

const API_URL = "/api/challenge";
const API_POST_URL = "/api/submit";

// Renderiza ranking em tabela
function renderRanking(tableId, rankingArray, key = "points") {
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = "";
  if (!rankingArray || rankingArray.length === 0) {
    tbody.innerHTML = `<tr><td colspan="3">No data</td></tr>`;
    return;
  }
  rankingArray.forEach((row, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i + 1}</td><td>${row.username}</td><td>${row[key] ?? 0}</td>`;
    tbody.appendChild(tr);
  });
}

// Carrega desafio + rankings
function loadChallenge() {
  fetch(API_URL)
    .then(res => res.json())
    .then(data => {
      console.log("JSON recebido do AppScript:", data); // log para diagnosticar
      if (data.error) {
        document.getElementById("emojis").innerText = "No challenge today!";
      } else {
        document.getElementById("emojis").innerText = data.emojis || "ü§î";
        answer = String(data.answer || "").toLowerCase().trim();
        const alt = String(data.alt || "");
        altAnswers = alt ? alt.toLowerCase().split(",").map(a => a.trim()) : [];
        challengeLoadedTime = new Date();

        renderRanking("dailyRanking", data.dailyTop || [], "points");
        renderRanking("overallRanking", data.overallTotal || [], "totalPoints");
      }
    })
    .catch(err => {
      console.error("Erro no fetch:", err);
      document.getElementById("emojis").innerText = "Error loading challenge.";
      renderRanking("dailyRanking", [], "points");
      renderRanking("overallRanking", [], "totalPoints");
    });
}

loadChallenge();

function calculatePoints(elapsedSeconds, attempts) {
  const base = 1000;
  const timePenalty = elapsedSeconds * 2;
  const attemptsPenalty = Math.max(0, attempts - 1) * 50;
  return Math.max(base - timePenalty - attemptsPenalty, 0);
}

function sendScoreToSheet(username, points, attempts, elapsed) {
  const payload = { username, challengeDate: new Date().toISOString().split("T")[0], points, attempts, elapsed };
  return fetch(API_POST_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).then(res => res.json());
}

function checkAnswer() {
  const username = document.getElementById("username").value.trim();
  if (!username) { alert("Please enter your name!"); return; }

  attempts++;
  const guess = document.getElementById("guess").value.trim().toLowerCase();

  if (guess && (guess === answer || altAnswers.includes(guess))) {
    const answerTime = new Date();
    const elapsed = (answerTime - challengeLoadedTime) / 1000;
    const points = Math.round(calculatePoints(elapsed, attempts));

    sendScoreToSheet(username, points, attempts, elapsed)
      .then(data => {
        console.log("Score enviado:", data);
        document.getElementById("result").innerText = "‚úÖ Correct!";
        document.getElementById("result").style.color = "green";
        loadChallenge(); // atualiza rankings ap√≥s envio
      })
      .catch(err => {
        console.error("Erro ao enviar score:", err);
        document.getElementById("result").innerText = "‚ö†Ô∏è Correct, but failed to record score.";
        document.getElementById("result").style.color = "orange";
      });
  } else {
    document.getElementById("result").innerText = "‚ùå Try again!";
    document.getElementById("result").style.color = "red";
  }
}

document.getElementById("submitBtn").addEventListener("click", checkAnswer);
</script>
</body>
</html>
