<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Guessmoji - Daily Emoji Challenge</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 30px; background-color: #f9f9f9; }
    h1 { font-size: 2em; }
    .emoji { font-size: 3em; margin: 20px 0; }
    .hint { font-size: 1em; color: #555; font-style: italic; margin-bottom: 20px; }
    input { padding: 10px; font-size: 1em; width: 250px; max-width: 90%; display: block; margin: 8px auto; }
    button { padding: 10px 15px; font-size: 1em; cursor: pointer; }
    #result, #loginMessage { margin-top: 15px; font-size: 1.2em; }
    footer { margin-top: 40px; font-size: 0.8em; color: #777; }

    .rankings { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; margin-top: 30px; }
    .ranking-box { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; width: 300px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .ranking-box h2 { font-size: 1.2em; margin-bottom: 10px; }
    .ranking-box table { width: 100%; border-collapse: collapse; }
    .ranking-box th, .ranking-box td { padding: 5px; border-bottom: 1px solid #eee; text-align: left; font-size: 0.9em; }
    .ranking-box th { background-color: #f5f5f5; }
  </style>
</head>
<body>

<h1>Guessmoji</h1>
<p>Can you guess today‚Äôs emoji puzzle? One challenge per day, worldwide!</p>

<div id="emojis" class="emoji">Loading...</div>
<p id="categoryHint" class="hint"></p>

<!-- Login / Register Section -->
<div id="authSection">
  <input id="usernameInput" placeholder="Enter username" />
  <input id="passwordInput" type="password" placeholder="Enter password" />
  <button id="loginBtn">Login</button>
  <button id="registerBtn">Register</button>
  <p id="loginMessage"></p>
</div>

<!-- Game Section -->
<div id="gameSection" style="display:none;">
  <input id="guess" placeholder="Type your answer here" />
  <button id="submitBtn">Submit</button>
  <p id="result"></p>
</div>

<div class="rankings">
  <div class="ranking-box">
    <h2>üèÜ Daily Top</h2>
    <table id="dailyRanking">
      <thead>
        <tr><th>#</th><th>User</th><th>Points</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="ranking-box">
    <h2>üåç Overall Top</h2>
    <table id="overallRanking">
      <thead>
        <tr><th>#</th><th>User</th><th>Points</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<footer>
  &copy; 2025 Guessmoji. All rights reserved.
</footer>

<script>
let answer = "";
let altAnswers = [];
let attempts = 0;
let challengeLoadedTime = new Date();
let currentUser = localStorage.getItem("guessmojiUser") || "";

// URLs
const API_CHALLENGE_URL = "/api/challenge";
const API_RANKING_URL = "/api/ranking";
const API_POST_URL = "/api/submit";
const API_USERS_URL = "/api/users"; // novo endpoint do UsersWebApp

// --- Render Ranking ---
function renderRanking(tableId, rankingArray, key = "points") {
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = "";
  if (!rankingArray || rankingArray.length === 0) {
    tbody.innerHTML = `<tr><td colspan="3">No data</td></tr>`;
    return;
  }
  rankingArray.forEach((row, i) => {
    const value = row[key] ?? row.points ?? row.totalPoints ?? 0;
    const username = row.username ?? "Unknown";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${username}</td><td>${value}</td>`;
    tbody.appendChild(tr);
  });
}

// --- Load Challenge ---
function loadChallenge() {
  fetch(API_CHALLENGE_URL)
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        document.getElementById("emojis").innerText = "No challenge today!";
        document.getElementById("categoryHint").innerText = "";
      } else {
        document.getElementById("emojis").innerText = data.emojis || "ü§î";
        document.getElementById("categoryHint").innerText = data.category ? `üí° Hint: ${data.category}` : "";
        answer = String(data.answer || "").toLowerCase().trim();
        const alt = String(data.alt || "");
        altAnswers = alt ? alt.toLowerCase().split(",").map(a => a.trim()) : [];
        challengeLoadedTime = new Date();
      }
    })
    .catch(err => {
      console.error("Erro no fetch challenge:", err);
      document.getElementById("emojis").innerText = "Error loading challenge.";
      document.getElementById("categoryHint").innerText = "";
    });
}

// --- Load Rankings ---
function loadRankings() {
  fetch(API_RANKING_URL)
    .then(res => res.json())
    .then(data => {
      renderRanking("dailyRanking", data.dailyTop || [], "points");
      renderRanking("overallRanking", data.overallTotal || [], "totalPoints");
    })
    .catch(err => {
      console.error("Erro no fetch rankings:", err);
      renderRanking("dailyRanking", [], "points");
      renderRanking("overallRanking", [], "totalPoints");
    });
}

// --- Points Calculation ---
function calculatePoints(elapsedSeconds, attempts) {
  const base = 1000;
  const timePenalty = elapsedSeconds * 2;
  const attemptsPenalty = Math.max(0, attempts-1)*50;
  return Math.max(base - timePenalty - attemptsPenalty, 0);
}

// --- Send Score ---
function sendScore(username, points, attempts, elapsed) {
  const payload = { username, challengeDate: new Date().toISOString().split("T")[0], points, attempts, elapsed };
  return fetch(API_POST_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) }).then(r=>r.json());
}

// --- Check Answer ---
function checkAnswer() {
  if (!currentUser) { alert("Please login first!"); return; }
  attempts++;
  const guess = document.getElementById("guess").value.trim().toLowerCase();
  if (guess && (guess === answer || altAnswers.includes(guess))) {
    const elapsed = (new Date()-challengeLoadedTime)/1000;
    const points = Math.round(calculatePoints(elapsed, attempts));
    sendScore(currentUser, points, attempts, elapsed)
      .then(data => {
        document.getElementById("result").innerText = "‚úÖ Correct!";
        document.getElementById("result").style.color = "green";
        loadRankings();
      })
      .catch(err=>{
        console.error(err);
        document.getElementById("result").innerText = "‚ö†Ô∏è Correct, but failed to record score.";
        document.getElementById("result").style.color = "orange";
      });
  } else {
    document.getElementById("result").innerText = "‚ùå Try again!";
    document.getElementById("result").style.color = "red";
  }
}

// --- Auth Functions ---
async function registerUser() {
  const username = document.getElementById("usernameInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  if (!username || !password) { alert("Enter username & password"); return; }
  const passwordHash = btoa(password); // hash simples
  const res = await fetch(API_USERS_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({action:"addUser", username, passwordHash, createdAt:new Date().toISOString()}) });
  const data = await res.json();
  if (data.status==="success") { localStorage.setItem("guessmojiUser", username); currentUser=username; showGame(); document.getElementById("loginMessage").innerText="Registered & logged in!"; }
  else { document.getElementById("loginMessage").innerText = data.message; }
}

async function loginUser() {
  const username = document.getElementById("usernameInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  if (!username || !password) { alert("Enter username & password"); return; }
  const passwordHash = btoa(password);
  const res = await fetch(API_USERS_URL).then(r=>r.json());
  const users = await res.json();
  const user = users.find(u=>u.username===username && u.passwordHash===passwordHash);
  if (user) { localStorage.setItem("guessmojiUser", username); currentUser=username; showGame(); document.getElementById("loginMessage").innerText="Logged in!"; }
  else { document.getElementById("loginMessage").innerText="Invalid username or password"; }
}

function showGame() {
  document.getElementById("authSection").style.display="none";
  document.getElementById("gameSection").style.display="block";
}

// --- Event Listeners ---
document.getElementById("submitBtn").addEventListener("click", checkAnswer);
document.getElementById("registerBtn").addEventListener("click", registerUser);
document.getElementById("loginBtn").addEventListener("click", loginUser);

// Auto-login se usu√°rio salvo
if (currentUser) showGame();

// Inicializa
loadChallenge();
loadRankings();
</script>
</body>
</html>
