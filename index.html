<script>
let answer = "";
let altAnswers = [];
let attempts = 0;
let challengeLoadedTime = new Date();
let currentUser = localStorage.getItem("guessmojiUser") || "";

// URLs
const API_CHALLENGE_URL = "/api/challenge";
const API_RANKING_URL = "/api/ranking";
const API_POST_URL = "/api/submit";
const API_USERS_URL = "https://script.google.com/macros/s/AKfycbylEwOHypdePUixYF1f99h9-Sm7KjPC08367sJtlwuFswart8Wq7iLar2GM4tObcbuDYw/exec"; // <<< COLE AQUI O URL DO UsersWebApp publicado

// --- Render Ranking ---
function renderRanking(tableId, rankingArray, key = "points") {
  const tbody = document.querySelector(`#${tableId} tbody`);
  tbody.innerHTML = "";
  if (!rankingArray || rankingArray.length === 0) {
    tbody.innerHTML = `<tr><td colspan="3">No data</td></tr>`;
    return;
  }
  rankingArray.forEach((row, i) => {
    const value = row[key] ?? row.points ?? row.totalPoints ?? 0;
    const username = row.username ?? "Unknown";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${i+1}</td><td>${username}</td><td>${value}</td>`;
    tbody.appendChild(tr);
  });
}

// --- Load Challenge ---
function loadChallenge() {
  fetch(API_CHALLENGE_URL)
    .then(res => res.json())
    .then(data => {
      if (data.error) {
        document.getElementById("emojis").innerText = "No challenge today!";
        document.getElementById("categoryHint").innerText = "";
      } else {
        document.getElementById("emojis").innerText = data.emojis || "ü§î";
        document.getElementById("categoryHint").innerText = data.category ? `üí° Hint: ${data.category}` : "";
        answer = String(data.answer || "").toLowerCase().trim();
        const alt = String(data.alt || "");
        altAnswers = alt ? alt.toLowerCase().split(",").map(a => a.trim()) : [];
        challengeLoadedTime = new Date();
      }
    })
    .catch(err => {
      console.error("Erro no fetch challenge:", err);
      document.getElementById("emojis").innerText = "Error loading challenge.";
      document.getElementById("categoryHint").innerText = "";
    });
}

// --- Load Rankings ---
function loadRankings() {
  fetch(API_RANKING_URL)
    .then(res => res.json())
    .then(data => {
      renderRanking("dailyRanking", data.dailyTop || [], "points");
      renderRanking("overallRanking", data.overallTotal || [], "totalPoints");
    })
    .catch(err => {
      console.error("Erro no fetch rankings:", err);
      renderRanking("dailyRanking", [], "points");
      renderRanking("overallRanking", [], "totalPoints");
    });
}

// --- Points Calculation ---
function calculatePoints(elapsedSeconds, attempts) {
  const base = 1000;
  const timePenalty = elapsedSeconds * 2;
  const attemptsPenalty = Math.max(0, attempts-1)*50;
  return Math.max(base - timePenalty - attemptsPenalty, 0);
}

// --- Send Score ---
function sendScore(username, points, attempts, elapsed) {
  const payload = { username, challengeDate: new Date().toISOString().split("T")[0], points, attempts, elapsed };
  return fetch(API_POST_URL, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload) }).then(r=>r.json());
}

// --- Check Answer ---
function checkAnswer() {
  if (!currentUser) { alert("Please login first!"); return; }
  attempts++;
  const guess = document.getElementById("guess").value.trim().toLowerCase();
  if (guess && (guess === answer || altAnswers.includes(guess))) {
    const elapsed = (new Date()-challengeLoadedTime)/1000;
    const points = Math.round(calculatePoints(elapsed, attempts));
    sendScore(currentUser, points, attempts, elapsed)
      .then(data => {
        document.getElementById("result").innerText = "‚úÖ Correct!";
        document.getElementById("result").style.color = "green";
        loadRankings();
      })
      .catch(err=>{
        console.error(err);
        document.getElementById("result").innerText = "‚ö†Ô∏è Correct, but failed to record score.";
        document.getElementById("result").style.color = "orange";
      });
  } else {
    document.getElementById("result").innerText = "‚ùå Try again!";
    document.getElementById("result").style.color = "red";
  }
}

// --- Auth Functions ---
async function registerUser() {
  const username = document.getElementById("usernameInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  if (!username || !password) { alert("Enter username & password"); return; }

  const res = await fetch(API_USERS_URL, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ 
      action: "addUser",
      username, 
      passwordHash: password, // por enquanto sem hash
      createdAt: new Date().toISOString()
    })
  });
  const data = await res.json();
  if (data.status==="success") {
    localStorage.setItem("guessmojiUser", username);
    currentUser=username;
    showGame();
    document.getElementById("loginMessage").innerText="Registered & logged in!";
  } else {
    document.getElementById("loginMessage").innerText = data.message || "Error registering";
  }
}

async function loginUser() {
  const username = document.getElementById("usernameInput").value.trim();
  const password = document.getElementById("passwordInput").value;
  if (!username || !password) { alert("Enter username & password"); return; }

  const res = await fetch(API_USERS_URL, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ 
      action: "login",
      username, 
      passwordHash: password
    })
  });
  const data = await res.json();
  if (data.status==="success") {
    localStorage.setItem("guessmojiUser", username);
    currentUser=username;
    showGame();
    document.getElementById("loginMessage").innerText="Logged in!";
  } else {
    document.getElementById("loginMessage").innerText= data.message || "Invalid username or password";
  }
}

function showGame() {
  document.getElementById("authSection").style.display="none";
  document.getElementById("gameSection").style.display="block";
}

// --- Event Listeners ---
document.getElementById("submitBtn").addEventListener("click", checkAnswer);
document.getElementById("registerBtn").addEventListener("click", registerUser);
document.getElementById("loginBtn").addEventListener("click", loginUser);

// Auto-login se usu√°rio salvo
if (currentUser) showGame();

// Inicializa
loadChallenge();
loadRankings();
</script>
